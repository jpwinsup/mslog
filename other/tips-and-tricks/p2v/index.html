<!DOCTYPE html>
<html lang="ja" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disk2vhd ツールを利用した P2V 化</title>
    
    <link rel="icon" href="https://jpwinsup.github.io/mslog/images/favicon.ico" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
        integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    <link rel="stylesheet" href="https://jpwinsup.github.io/mslog/css/style.min.6dfb5280fd5c3bdf4b0ef814a028c2d285a9e1833ad9bb2dce4762ca9f6291e8.css" integrity="sha256-bftSgP1cO99LDvgUoCjC0oWp4YM62bstzkdiyp9ikeg=" crossorigin="anonymous">
    
</head>

<body>
    <header class="header header-color">
    <nav class="navbar">
        <ul class="navbar-list">
            
            <li class="navbar-item"><a href="https://jpwinsup.github.io/mslog/"><img class="navbar-logo" src="https://jpwinsup.github.io/mslog/images/Microsoft-logo_rgb_c-wht.webp"
                        alt="Microsoft Logo"></a></li>
            <li class="navbar-item"><a class="navbar-item-style" href="https://jpwinsup.github.io/mslog/">ホーム</a></li>
            <li class="navbar-item"><a class="navbar-item-style" href="https://cssjpn.github.io/"
                    target="_blank">サポート情報</a>
            </li>
            <li class="navbar-item"><a class="navbar-item-style" href="https://jpwinsup.github.io/blog/"
                    target="_blank">サポート ブログ</a>
            </li>
        </ul>
    </nav>
</header>

    
<div class="page-wrapper">
    <div class="sidebar sidebar-color">
    <h3 class="sidebar-header sidebar-header-style">カテゴリー</h3>
    
    
    <ul class="sidebar-list">
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/directory-service/">Directory Service</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/hyper-v/">Hyper-V</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/cluster/">クラスター</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/storage/">ストレージ</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/performance/">パフォーマンス</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/networking/">ネットワーク一般</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/wireless/">ワイヤレス ネットワーク</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/file-services/">ファイル サービス</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/uwp/">UWP</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/rdp/">リモートアクセス</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-style"
                href="https://jpwinsup.github.io/mslog/core/">コア</a></li>
        
        
        <li class="sidebar-list-item sidebar-list-item-style"><a
                class="sidebar-list-link-accent-style"
                href="https://jpwinsup.github.io/mslog/other/">その他</a></li>
        
    </ul>
    
</div>
    <div class="content content-color">
        <article>
            <h1>Disk2vhd ツールを利用した P2V 化</h1>
            <h3>目次</h3>
            
            <nav id="TableOfContents">
  <ul>
    <li><a href="#p2v-化の流れ">P2V 化の流れ</a>
      <ul>
        <li><a href="#1-ドライブにラベル名を付与">1. ドライブにラベル名を付与</a></li>
        <li><a href="#2-disk2vhd-ツールの-zip-ファイルをダウンロード展開">2. Disk2vhd ツールの zip ファイルをダウンロード・展開</a></li>
        <li><a href="#3-windows-pe-winpe-メディアの作成">3. Windows PE (WinPE) メディアの作成</a></li>
        <li><a href="#4-disk2vhd-ツールで仮想ディスクを作成">4. Disk2vhd ツールで仮想ディスクを作成</a></li>
        <li><a href="#5-hyper-v-で起動">5. Hyper-V で起動</a></li>
      </ul>
    </li>
    <li><a href="#回復環境が利用できない環境での変換方法">回復環境が利用できない環境での変換方法</a></li>
    <li><a href="#windows-pepe-でネットワークドライブにドライブレターを割り当てる方法">Windows PE/PE でネットワークドライブにドライブレターを割り当てる方法</a></li>
  </ul>
</nav>
            <p>本記事はマイクロソフト社員によって公開されております。</p>
<p>いつも弊社製品をご利用いただきまして誠にありがとうございます。Windows プラットフォーム サポートの栗木です。</p>
<p>今回は、<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/disk2vhd"  target="_blank" >Disk2vhd ツール</a> を利用し、物理環境の物理ディスクから Hyper-V で使用できる仮想ディスクを作成する P2V 化についてご紹介いたします。仮想環境で実行することにより、ハードウェア要因の問題を切り分けられたり、問題を引き起こしている可能性のあるソフトウェアのアンインストールが容易になり、問題解決がスムーズに達成できる可能性がございます。</p>
<p>Disk2vhd ツールは VSS に対応しているため、OS を起動させた状態で実行可能ではございますが、VSS に対応していないアプリケーションや実行時の負荷などを考慮すると、Windows PE/RE (プレインストール環境/回復環境)で実施いただいたほうが安全ため、本記事では Windows PE/RE での P2V 化の手順をご紹介いたします。回復環境が利用できない場合は、後述する <a href="#%e5%9b%9e%e5%be%a9%e7%92%b0%e5%a2%83%e3%81%8c%e5%88%a9%e7%94%a8%e3%81%a7%e3%81%8d%e3%81%aa%e3%81%84%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%ae%e5%a4%89%e6%8f%9b%e6%96%b9%e6%b3%95" >回復環境が利用できない環境での変換方法</a> より仮想ディスクを作成してください。</p>
<p>Windows プレインストール環境 (Windows PE)
<a href="https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-intro"  target="_blank" >https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-intro</a></p>
<p>Windows 回復環境 (Windows RE)
<a href="https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/windows-recovery-environment--windows-re--technical-reference"  target="_blank" >https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/windows-recovery-environment--windows-re--technical-reference</a></p>
<p>注意点:
本記事は検証目的として Disk2vhd による P2V 化手順をご案内しております。Disk2vhd ツールは Windows 標準ツールではございませんのでサポート内容については使用許諾をご確認いただきご理解いただいた上でご利用ください。</p>
<h2 id="p2v-化の流れ">P2V 化の流れ</h2>
<ol>
<li>ドライブにラベル名を付与</li>
<li>Disk2vhd ツールの zip ファイルをダウンロード・展開</li>
<li>Windows PE (WinPE) メディアの作成</li>
<li>Disk2vhd ツールで仮想ディスクを作成</li>
<li>Hyper-V で起動</li>
</ol>
<h3 id="1-ドライブにラベル名を付与">1. ドライブにラベル名を付与</h3>
<p>Windows PE/RE で起動すると、ドライブ レターが通常の OS 起動時と異なる可能性がございます。そのため、ラベル名を変更し、ラベル名から判別できるようにします。すでに OS が通常起動できないエラー状態にある場合は、こちらの手順はできませんので、スキップしてください。</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/label.png" alt=""></p>
<h3 id="2-disk2vhd-ツールの-zip-ファイルをダウンロード展開">2. Disk2vhd ツールの zip ファイルをダウンロード・展開</h3>
<p>以下の Web サイトから Disk2vhd ツールをダウンロードし、USB メモリ等の外部ストレージに展開します。
Disk2vhd：https://docs.microsoft.com/en-us/sysinternals/downloads/disk2vhd</p>
<h3 id="3-windows-pe-winpe-メディアの作成">3. Windows PE (WinPE) メディアの作成</h3>
<p>P2V 化したいシステムに Windows RE がインストールされている場合(A)や Windows OS のインストール メディアがある場合(B)は、以下の方法で、Windows RE を起動できます。そのため、Windows PE (WinPE) メディアの作成をする必要ありませんのでこちらの手順はスキップできます。</p>
<p>A. コマンドプロンプト（管理者権限）から Windows RE を起動</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>reagentc /boottore &amp;&amp; shutdown /r /t 0 /f
</span></span></code></pre></div><p>B. インストール メディアから <strong>コンピューターを修復する</strong> を選択し、Windows RE を起動</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/fix.png" alt=""></p>
<p>上記の方法で、Windows RE を起動できない場合は、次の手順より、Windows PE (WinPE) メディアを作成してください。</p>
<ol>
<li>
<p>作業用の Windows 10/11 環境にて Windows ADK をインストール
Windows ADK のダウンロードとインストール
<a href="https://docs.microsoft.com/ja-jp/windows-hardware/get-started/adk-install"  target="_blank" >https://docs.microsoft.com/ja-jp/windows-hardware/get-started/adk-install</a></p>
</li>
<li>
<p>以下の Web サイトを参考に WinPE のブートメディアを作成
起動可能な Windows PE メディアの作成
<a href="https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-create-usb-bootable-drive"  target="_blank" >https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-create-usb-bootable-drive</a></p>
</li>
</ol>
<h3 id="4-disk2vhd-ツールで仮想ディスクを作成">4. Disk2vhd ツールで仮想ディスクを作成</h3>
<ol>
<li>
<p>Windows PE/RE で、コマンド プロンプトを実行
Windows PE は、自動的にコマンド プロンプトが起動し、wpeinit の自動実行が完了するとプロンプトが戻ります。プロンプトが戻るまで、5～10 分程かかる場合がございます。
Windows RE では、トラブルシューティング -&gt; コマンド プロンプトを選択することにより、コマンドプロンプトを実行できます。</p>
</li>
<li>
<p>Disk2vhd ツールを実行し、設定を変更
※実行時には使用許諾が表示されますので、同意 (Agree) していただいた上でご利用ください。<!-- raw HTML omitted -->
・ &ldquo;Use Vhdx&rdquo; のチェックをつけます。
・ &ldquo;Use Volume Shadow Copy&rdquo; のチェックを外します。
・ &ldquo;VHD File name&rdquo; にvhdx の保存先とファイル名を指定します。
・ 仮想ディスクに変換したいボリュームにチェックをつけます。<!-- raw HTML omitted -->
名前が、\\?\Volume から始まるボリュームがある場合は、必ずチェックをお願いします。上述いたしましたが、OS を通常起動した場合とドライブ レターが異なる場合がありますので <strong>Label</strong> を参考に必要なボリュームを選択してください。例えば、システム ディスクである C ドライブが D ドライブにアサインされていることがあります。
出力先にネットワークドライブを指定したい場合は、後述の <a href="#Windows-PE-PE-%e3%81%a7%e3%83%8d%e3%83%83%e3%83%88%e3%83%af%e3%83%bc%e3%82%af%e3%83%89%e3%83%a9%e3%82%a4%e3%83%96%e3%81%ab%e3%83%89%e3%83%a9%e3%82%a4%e3%83%96%e3%83%ac%e3%82%bf%e3%83%bc%e3%82%92%e5%89%b2%e3%82%8a%e5%bd%93%e3%81%a6%e3%82%8b%e6%96%b9%e6%b3%95" >ネットワークドライブにドライブレターを割り当てる方法</a> を参考に IP アドレスの設定とファイルサーバーへの接続を先に実行してください。</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/disk2vhd_pe.png" alt=""></p>
</li>
<li>
<p><strong>Create</strong> をクリックして、仮想ディスクを作成
選択したボリュームが複数の物理ディスクにある場合は、複数の仮想ディスクが連番のファイル名で作成されます。
正常に完了しましたら、<strong>Close</strong> をクリックし、ツールを終了させ、コマンド プロンプトで <code>wpeutil shutdown</code> を実行してシステムをシャットダウンします。</p>
</li>
</ol>
<h3 id="5-hyper-v-で起動">5. Hyper-V で起動</h3>
<h4 id="bios-環境">BIOS 環境</h4>
<p>Disk2vhd ツールは、BIOS 環境用に作られているため、もともとの物理端末が BIOS 環境であれば、次の PowerShell コマンドにより、Disk2vhd で作成した仮想ディスクを指定し、Hyper-V 仮想マシンを作成・起動することができます。メモリのサイズやプロセッサーの数は、ご希望の値に変更してください。</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>New-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span> -MemoryStartupBytes <span style="color:#a5d6ff">4</span>GB -Generation <span style="color:#a5d6ff">1</span> -VHDPath <span style="color:#a5d6ff">&#34;D:\path\to\vhd\test.vhdx&#34;</span>
</span></span><span style="display:flex;"><span>Set-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span> -StaticMemory -ProcessorCount <span style="color:#a5d6ff">4</span>
</span></span><span style="display:flex;"><span>Start-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span>
</span></span></code></pre></div><p>New-VM: <a href="https://docs.microsoft.com/en-us/powershell/module/hyper-v/new-vm"  target="_blank" >https://docs.microsoft.com/en-us/powershell/module/hyper-v/new-vm</a>
Set-VM: <a href="https://docs.microsoft.com/en-us/powershell/module/hyper-v/set-vm"  target="_blank" >https://docs.microsoft.com/en-us/powershell/module/hyper-v/set-vm</a>
Start-VM: <a href="https://docs.microsoft.com/ja-jp/powershell/module/hyper-v/start-vm"  target="_blank" >https://docs.microsoft.com/ja-jp/powershell/module/hyper-v/start-vm</a></p>
<h4 id="uefi-環境">UEFI 環境</h4>
<p>UEFI 環境の場合は、そのままの状態では OS の起動ができないことがございます。その場合には、Hyper-V 仮想マシンを作成した後に、OS が起動できるようにシステム パーティションの初期化処理を Windows PE/RE で実施する必要があります。</p>
<ol>
<li>Hyper-V 仮想マシンを作成
第 2 世代の仮想マシンとして、Disk2vhd で作成した仮想ディスクを指定して、Hyper-V 仮想マシンを作成・起動します。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>New-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span> -MemoryStartupBytes <span style="color:#a5d6ff">4</span>GB -Generation <span style="color:#a5d6ff">2</span> -VHDPath <span style="color:#a5d6ff">&#34;D:\path\to\vhd\test.vhdx&#34;</span>
</span></span><span style="display:flex;"><span>Set-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span> -StaticMemory -ProcessorCount <span style="color:#a5d6ff">4</span>
</span></span><span style="display:flex;"><span>Start-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span>
</span></span></code></pre></div><p>仮想マシン起動後に、以下のような画面が表示されている場合は、システム パーティションの初期化が必要なので、次の手順に進んでください。</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/noboot.png" alt=""></p>
<ol start="2">
<li>Windows PE/RE で起動
Windows OS のインストール メディア の ISO ファイル、または Windows PE の ISO ファイルを仮想マシンのディスク ドライブに追加し、起動します。ISO ファイルがない場合は、上述した<a href="#3-Windows-PE-WinPE-%e3%83%a1%e3%83%87%e3%82%a3%e3%82%a2%e3%81%ae%e4%bd%9c%e6%88%90" >Windows PE (WinPE) メディアの作成</a> へ戻り、ISO ファイルを作成してください。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>Add-VMDvdDrive -VMName <span style="color:#a5d6ff">&#34;TestVM&#34;</span> -Path <span style="color:#a5d6ff">&#34;D:\path\to\InstallMedia\or\WinPE\disk.iso&#34;</span>
</span></span><span style="display:flex;"><span>Start-VM -Name <span style="color:#a5d6ff">&#34;TestVM&#34;</span>
</span></span></code></pre></div><p>仮想マシン起動時に &ldquo;Press any key to boot from CD or DVD&rdquo; のメッセージが表示されるので、任意のキー入力してください。</p>
<ol start="3">
<li>
<p>コマンド プロンプトから diskpart ツールを起動
Windows PE メディアから起動した場合は、自動的にコマンド プロンプトが起動します。Windows OS のインストール メディアから起動した場合は、Shift+F10 キーを入力するとコマンド プロンプトを起動できます。
コマンド プロンプトが起動したら、<code>diskpart</code> を実行してください。</p>
</li>
<li>
<p>diskpart ツールでシステム パーティションの初期化
まず、<code>list disk</code> コマンドで現在のディスクを確認し、<code>sel disk (ディスク番号)</code> を実行し、ディスクを選択します。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DISKPART&gt; list disk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Disk ###  Status         Size     Free     Dyn  Gpt
</span></span><span style="display:flex;"><span>  --------  -------------  -------  -------  ---  ---
</span></span><span style="display:flex;"><span>  Disk 0    Online          238 GB      0 B        *
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DISKPART&gt; sel disk 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disk 0 is now the selected disk.
</span></span></code></pre></div><p>次に <code>list part</code> コマンドでシステム パーティションを確認し、<code>sel part (パーティション番号)</code> コマンドを実行し、システム パーティションを選択します。</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DISKPART&gt; list part
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Partition ###  Type              Size     Offset
</span></span><span style="display:flex;"><span>  -------------  ----------------  -------  -------
</span></span><span style="display:flex;"><span>  Partition 1    System             100 MB  1024 KB
</span></span><span style="display:flex;"><span>  Partition 2    Reserved            16 MB   101 MB
</span></span><span style="display:flex;"><span>  Partition 3    Primary            127 GB   117 MB
</span></span><span style="display:flex;"><span>  Partition 4    Recovery           563 MB   127 GB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DISKPART&gt; sel part 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Partition 1 is now the selected partition.
</span></span></code></pre></div><p><code>format quick fs=fat32 label=&quot;System&quot;</code> コマンドを実行して、パーティションをフォーマットします。</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DISKPART&gt; format quick fs=fat32 label=&#34;System&#34;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>     100 percent completed
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DiskPart successfully formatted the volume.
</span></span></code></pre></div><p><code>assign</code> コマンドでフォーマットしたボリュームにドライブレターを割り当て、<code>list vol</code> コマンドを実行して、システム ボリュームのドライブ レターを確認します。この例では、E ドライブと確認できます。</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DISKPART&gt; assign
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DiskPart successfully assigned the drive letter or mount point.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DISKPART&gt; list vol
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  Volume ###  Ltr  Label         Fs     Type        Size     Status     Info
</span></span><span style="display:flex;"><span>  ----------  ---  ------------  -----  ----------  -------  ---------  -------
</span></span><span style="display:flex;"><span>  Volume 0     D   DVD_ROM       UDF    DVD-ROM      295 MB  Healthy
</span></span><span style="display:flex;"><span>  Volume 1     C   OS            NTFS   Partition    127 GB  Healthy
</span></span><span style="display:flex;"><span>  Volume 2                       NTFS   Partition    563 MB  Healthy
</span></span><span style="display:flex;"><span>* Volume 3     E   SYSTEM        FAT32  Partition    100 MB  Healthy    Hidden
</span></span></code></pre></div><p><code>exit</code> コマンドで diskpart ツールを終了します。</p>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DISKPART&gt; exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Leaving DiskPart...
</span></span></code></pre></div><ol start="5">
<li>ブート ファイルの作成
コマンド プロンプトで <code>bcdboot (Windows のドライブレター)\Windows /s (システム パーティションのドライブ レター):</code> でブート ファイルを作成します。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>X:\windows\system32&gt;bcdboot c:\Windows /s e:
</span></span><span style="display:flex;"><span>Boot files successfully created.
</span></span></code></pre></div><p>これで作業は完了したので、<code>wpeutil shutdown</code> コマンドを実行してシステムをシャットダウンします。
ISO イメージをアンマウントし、Hyper-V 仮想マシンが起動できるか確認してください。</p>
<h2 id="回復環境が利用できない環境での変換方法">回復環境が利用できない環境での変換方法</h2>
<ol>
<li>
<p>以下の Web サイトから Disk2vhd ツールをダウンロードし、任意のパスに展開します。
Disk2vhd：https://docs.microsoft.com/en-us/sysinternals/downloads/disk2vhd</p>
</li>
<li>
<p>disk2vhd64.exe を実行し、設定を変更
※実行時には使用許諾が表示されますので、同意 (Agree) していただいた上でご利用ください。<!-- raw HTML omitted -->
・ &ldquo;Use Vhdx&rdquo; のチェックをつけます。
・ &ldquo;Use Volume Shadow Copy&rdquo; のチェックをつけます。
・ &ldquo;VHD File name&rdquo; にvhdx の保存先とファイル名を指定します。
・ 仮想ディスクに変換したいボリュームにチェックをつけます。<!-- raw HTML omitted -->
名前が、\\?\Volume から始まるボリュームがある場合は、必ずチェックをお願いします。</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/disk2vhd_os.png" alt=""></p>
</li>
<li>
<p>Create をクリックして、仮想ディスクを作成
選択したボリュームが複数の物理ディスクにある場合は、複数の仮想ディスクが連番のファイル名で作成されます。
正常に完了しましたら、Close をクリックし、ツールを終了させます。</p>
</li>
</ol>
<h2 id="windows-pepe-でネットワークドライブにドライブレターを割り当てる方法">Windows PE/PE でネットワークドライブにドライブレターを割り当てる方法</h2>
<p>ネットワークドライブに保存するためには、IP アドレスの設定を行った上で、接続を行います。ただし、システムに搭載されているネットワークインターフェースカード (NIC) が WinPE に含まれている標準ドライバーで認識できる必要がございます。認識されない場合は、個別にハードウェアベンダー様より提供されているドライバーを適用した状態で Windows PE メディアを作成してください。</p>
<ol>
<li>
<p>コマンドプロンプトにて netsh コマンドを利用して IP アドレスを設定
netsh int ipv4 show int ※ 対象のネットワークアダプターの Idx の番号を確認します。
netsh int ipv4 set address &ldquo;Idx の番号&rdquo; static &ldquo;IP アドレス&rdquo; &ldquo;サブネットマスク&rdquo; &ldquo;ゲートウェイ&rdquo; &ldquo;メトリック(省略可)&rdquo;</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/netshint.png" alt=""></p>
</li>
<li>
<p>Net コマンドにてファイルサーバーに接続
net use &ldquo;ドライブ文字:&rdquo; &ldquo;共有パス&rdquo; /user:&ldquo;接続するアカウント&rdquo; &ldquo;パスワード&rdquo;</p>
<p><img src="https://jpwinsup.github.io/mslog/other/tips-and-tricks/p2v/netuse.png" alt=""></p>
</li>
</ol>
<p>本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

        </article>
    </div>
</div>


    <footer class="footer footer-color">
    <div class="footer-container">
        
        <img class="footer-logo" src="https://jpwinsup.github.io/mslog/images/Microsoft-logo_rgb_c-wht.webp" alt="Microsoft Logo">
        <nav class="footer-links">
            <ul class="footer-links-list">
                <li class="footer-links-item"><a class="footer-links-style" href="https://jpwinsup.github.io/mslog/">ホーム</a></li>
                <li class="footer-links-item"><a class="footer-links-style" href="https://cssjpn.github.io/"
                        target="_blank">サポート情報</a></li>
                <li class="footer-links-item"><a class="footer-links-style" href="https://jpwinsup.github.io/blog/"
                        target="_blank">サポート ブログ</a></li>
            </ul>
        </nav>
    </div>
    <p class="footer-copy footer-copy-style">© 2023 Microsoft Japan Windows サポート チーム</p>
</footer>

</body>

</html>