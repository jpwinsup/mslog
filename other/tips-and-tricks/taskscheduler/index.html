<!doctype html><html lang=ja data-theme=light><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>タスク スケジューラによる資料採取</title><link rel=icon href=https://jpwinsup.github.io/mslog/images/favicon.ico><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://jpwinsup.github.io/mslog/css/style.min.2cf2d83b70054c6a1f941ece9e04f670c1ca9e5d7906b9f613c2128026f68c85.css integrity="sha256-LPLYO3AFTGoflB7OngT2cMHKnl15Brn2E8ISgCb2jIU=" crossorigin=anonymous></head><body><header class="header header-color"><nav class=navbar><ul class=navbar-list><li class=navbar-item><a href=https://jpwinsup.github.io/mslog/><img class=navbar-logo src=https://jpwinsup.github.io/mslog/images/Microsoft-logo_rgb_c-wht.webp alt="Microsoft Logo"></a></li><li class=navbar-item><a class=navbar-item-style href=https://jpwinsup.github.io/mslog/>ホーム</a></li><li class=navbar-item><a class=navbar-item-style href=https://cssjpn.github.io/ target=_blank>サポート情報</a></li><li class=navbar-item><a class=navbar-item-style href=https://jpwinsup.github.io/blog/ target=_blank>サポート ブログ</a></li></ul></nav></header><div class=page-wrapper><div class="sidebar sidebar-color"><h3 class="sidebar-header sidebar-header-style">カテゴリー</h3><ul class=sidebar-list><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/directory-service/>Directory Service</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/hyper-v/>Hyper-V</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/cluster/>クラスター</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/storage/>ストレージ</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/performance/>パフォーマンス</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/networking/>ネットワーク一般</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/wireless/>ワイヤレス ネットワーク</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/file-services/>ファイル サービス</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/uwp/>UWP</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/rdp/>リモートアクセス</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-style href=https://jpwinsup.github.io/mslog/core/>コア</a></li><li class="sidebar-list-item sidebar-list-item-style"><a class=sidebar-list-link-accent-style href=https://jpwinsup.github.io/mslog/other/>その他</a></li></ul></div><div class="content content-color"><article><h1>タスク スケジューラによる資料採取</h1><h3>目次</h3><nav id=TableOfContents><ul><li><a href=#設定の流れ>設定の流れ</a></li><li><a href=#bat-ファイル作成>Bat ファイル作成</a></li><li><a href=#資料採取用のタスク作成>資料採取用のタスク作成</a></li><li><a href=#作成したタスクの確認>作成したタスクの確認</a></li><li><a href=#作成したタスクの削除>作成したタスクの削除</a></li></ul></nav><p>本記事はマイクロソフト社員によって公開されております。</p><p>いつも弊社製品をご利用いただきまして誠にありがとうございます。Windows プラットフォーム サポートの栗木です。</p><p>Windows には作業を自動化できる機能として「タスク スケジューラ」が標準で提供されています。本記事では、タスク スケジューラを使用して調査に必要な資料採取を行う方法をご紹介いたします。注意として、資料採取用のタスクを作成するコマンドは、管理者として起動したコマンド プロンプトで実行してください。
なお、コマンドで紹介しておりますが、タスク スケジューラは、以下の方法で実行できる GUI でも操作できるツールになります。</p><p>タスク スケジューラ実行方法：
［Windows］＋［R］キーで［ファイル名を指定して実行］ダイアログを表示し「taskschd.msc」と入力した後に［Enter］キーを押す。</p><h2 id=設定の流れ>設定の流れ</h2><ol><li>資料採取処理をまとめた bat ファイルを作成</li><li>schtasks コマンドで資料採取用のタスクを作成</li></ol><h2 id=bat-ファイル作成>Bat ファイル作成</h2><p>今回は、WPRによる資料採取を１０分行う処理を bat ファイルにまとめたものを例とし、C:\mslog\wprlogging.bat に保存した状況で話を進めていきます。bat ファイルの処理内容や保存先は、調査で必要な資料や状況に合わせて変更可能です。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#79c0ff>@echo</span> off
</span></span><span style=display:flex><span>C:\Windows\System32\wpr.<span style=color:#79c0ff>exe</span> -start GeneralProfile -start CPU -start DiskIO -start FileIO -filemode -recordtempto <span style=color:#a5d6ff>&#34;C:\mslog&#34;</span>
</span></span><span style=display:flex><span>timeout /t <span style=color:#a5d6ff>600</span>
</span></span><span style=display:flex><span>C:\Windows\System32\wpr.<span style=color:#79c0ff>exe</span> -stop <span style=color:#a5d6ff>&#34;C:\mslog\output.etl&#34;</span>
</span></span></code></pre></div><p>Windows Performance Recorder (WPR)：https://docs.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-recorder
timeout コマンド：https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/timeout</p><h2 id=資料採取用のタスク作成>資料採取用のタスク作成</h2><p>資料採取を行いたい頻度に合わせて、資料採取用のタスクを作成します。
なお、TaskName の部分は任意の名前に、C:\mslog\wprlogging.bat の部分は、保存した bat ファイルの場所に変更ができます。</p><ol><li>時間を指定して１回だけ実行
例：2022年９月１日の午前９時に C:\mslog\wprlogging.bat を System アカウントで実行する。</li></ol><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>schtasks /create /tn <span style=color:#a5d6ff>&#34;TaskName&#34;</span> /sc ONCE /sd <span style=color:#a5d6ff>2022</span>/<span style=color:#a5d6ff>09</span>/<span style=color:#a5d6ff>01</span> /st <span style=color:#a5d6ff>09</span><span style=color:#f85149>:</span><span style=color:#a5d6ff>00</span> /tr <span style=color:#a5d6ff>&#34;C:\mslog\wprlogging.bat&#34;</span> /ru system /rl highest
</span></span></code></pre></div><ol start=2><li>毎日時間を指定して実行
例：2022年９月１日から毎日、午前９時に C:\mslog\wprlogging.bat を System アカウントで実行する。</li></ol><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>schtasks /create /tn <span style=color:#a5d6ff>&#34;TaskName&#34;</span> /sc DAILY /sd <span style=color:#a5d6ff>2022</span>/<span style=color:#a5d6ff>09</span>/<span style=color:#a5d6ff>01</span> /st <span style=color:#a5d6ff>09</span><span style=color:#f85149>:</span><span style=color:#a5d6ff>00</span> /tr <span style=color:#a5d6ff>&#34;C:\mslog\wprlogging.bat&#34;</span> /ru system /rl highest
</span></span></code></pre></div><ol start=3><li>毎週時間を指定して実行
例：2022年９月１日以降毎週金曜日、午前９時に C:\mslog\wprlogging.bat を System アカウントで実行する。</li></ol><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>schtasks /create /tn <span style=color:#a5d6ff>&#34;TaskName&#34;</span> /sc WEEKLY /sd <span style=color:#a5d6ff>2022</span>/<span style=color:#a5d6ff>09</span>/<span style=color:#a5d6ff>01</span> /st <span style=color:#a5d6ff>09</span><span style=color:#f85149>:</span><span style=color:#a5d6ff>00</span> /d FRI /tr <span style=color:#a5d6ff>&#34;C:\mslog\wprlogging.bat&#34;</span> /ru system /rl highest
</span></span></code></pre></div><p>コマンド 実行結果（例）</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>成功: スケジュール タスク &#34;TaskName&#34; は正しく作成されました。
</span></span></code></pre></div><p>代表的なものを紹介しましたが、さらに柔軟な頻度でのタスク作成も可能です。詳細は、以下の Web サイトに記載がありますので、確認をお願いします。
schtasks create コマンド：https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks-create</p><h2 id=作成したタスクの確認>作成したタスクの確認</h2><p>schtasks create コマンドを実行した後に、正常に資料採取用のタスクが作成されているかは、schtasks query コマンドを実行して確認ができます。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>schtasks /query /tn <span style=color:#a5d6ff>&#34;TaskName&#34;</span>
</span></span></code></pre></div><p>コマンド 実行結果（例）</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>フォルダー\
</span></span><span style=display:flex><span>タスク名                                  次回の実行時刻         状態
</span></span><span style=display:flex><span>======================================== ====================== ===============
</span></span><span style=display:flex><span>TaskName                                 2022/09/01 09:00:00    準備完了
</span></span></code></pre></div><p>schtasks query コマンド：https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks-query</p><h2 id=作成したタスクの削除>作成したタスクの削除</h2><p>作成したタスクは、以下のコマンドを実行することで削除が可能です。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>schtasks /delete /f /tn <span style=color:#a5d6ff>&#34;TaskName&#34;</span>
</span></span></code></pre></div><p>コマンド 実行結果（例）</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>成功: スケジュール タスク &#34;TaskName&#34; は正しく削除されました。
</span></span></code></pre></div><p>schtasks delete コマンド：https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks-delete</p><p>本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p></article></div></div><footer class="footer footer-color"><div class=footer-container><img class=footer-logo src=https://jpwinsup.github.io/mslog/images/Microsoft-logo_rgb_c-wht.webp alt="Microsoft Logo"><nav class=footer-links><ul class=footer-links-list><li class=footer-links-item><a class=footer-links-style href=https://jpwinsup.github.io/mslog/>ホーム</a></li><li class=footer-links-item><a class=footer-links-style href=https://cssjpn.github.io/ target=_blank>サポート情報</a></li><li class=footer-links-item><a class=footer-links-style href=https://jpwinsup.github.io/blog/ target=_blank>サポート ブログ</a></li></ul></nav></div><p class="footer-copy footer-copy-style">© 2023 Microsoft Japan Windows サポート チーム</p></footer></body></html>